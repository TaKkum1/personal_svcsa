<div class="inside-banner block track-banner">
    <h3>为运动员报名项目</h3>
    <p>团结拼搏，一起奉献。</p>
</div>

<style>
    .dropdown { display: none; }
</style>

<div class="site-box">
    <div class="block">
        <span class="icon-home home_icon icon"></span><a href="{:url('index/index/index')}">首页</a><span class="icon-arrow-right arrow_icon icon"></span><span class="active">项目报名</span>
    </div>
</div>
</div>

<div class="link-wrap block clearfix">
    <div class="txt-box">
        <h3>填写/选择有关信息，为华锦赛运动员报名项目！</h3>
        <ul>
            <li>要求/说明</li>
            <li>要求/说明</li>
            <li>要求/说明</li>
            <li>要求/说明</li>
        </ul>
    </div>

    <form action="" id="apply-form" method="post" >
        <div class="form-box" style="height: 300px;" >
            <div class="shared">
                <div class="input-box mb-5">
                    <label for="SeasonID" style="width: 70px;"><b>赛季：</b></label>        
                    <select  name="SeasonID" id="SeasonID" lay-filter="SeasonClick" style="width: 240px;">
                        <option value="">选择赛季</option>
                    </select>
                </div>
                <div class="input-box mb-5">
                    <label for="TeamID" style="width: 70px;"><b>队伍：</b></label>        
                    <select name="TeamID" id="TeamID" style="width: 240px;">
                        <option value="">选择队伍</option>
                    </select>
                </div>
                <div class="input-box mb-5">
                    <label for="ItemID" style="width: 70px;"><b>项目: </b></label>        
                    <select name="ItemID" id="ItemID" style="width: 240px;" lay-verify="required" lay-filter="ItemIDClick">
                        <option value="">选择项目</option>
                    </select>
                </div>
            </div>
            
            <div class="dropdown" id="0-dropdown">
                <div class="input-box mb-5">
                    <label for="Sex" style="width: 70px;"><b>性别组: </b></label>        
                    <select name="Sex" id="Sex" style="width: 240px;">
                        <option value="">选择性别组</option>
                    </select>
                </div>
                <div class="input-box mb-5">
                    <label for="AgeGroupID" style="width: 70px;"><b>年龄组: </b></label>        
                    <select name="AgeGroupID" id="AgeGroupID" style="width: 240px;">
                        <option value="">选择年龄组</option>
                    </select>
                </div>
                <div class="input-box mb-5">
                    <label for="PlayerID" style="width: 70px;"><b>接力队员: </b></label>        
                    <select name="PlayerID1" id="PlayerID1" style="width: 240px;" lay-filter="PlayerClick1">
                        <option value="">选择队员#1 (必填)</option>
                    </select>
                    <select name="PlayerID2" id="PlayerID2" style="width: 240px;" lay-filter="PlayerClick2">
                        <option value="">选择队员#2 (必填)</option>
                    </select>
                    <select name="PlayerID3" id="PlayerID3" style="width: 240px;" lay-filter="PlayerClick3">
                        <option value="">选择队员#3 (必填)</option>
                    </select>
                    <select name="PlayerID4" id="PlayerID4" style="width: 240px;" lay-filter="PlayerClick4">
                        <option value="">选择队员#4 (必填)</option>
                    </select>
                    <select name="PlayerID5" id="PlayerID5" style="width: 240px;" lay-filter="PlayerClick5">
                        <option value="">选择队员#5 (选填)</option>
                    </select>
                    <select name="PlayerID6" id="PlayerID6" style="width: 240px;" lay-filter="PlayerClick6">
                        <option value="">选择队员#6 (选填)</option>
                    </select>
                </div>
            </div>
            <div class="dropdown" id="1-dropdown">
                <div class="input-box mb-5">
                    <label for="PlayerID" style="width: 70px;"><b>参赛队员: </b></label>        
                    <select name="PlayerID" id="PlayerID" style="width: 240px;">
                        <option value="">选择参赛队员</option>
                    </select>
                </div>
                <div class="input-box mb-5">
                    <label for="Sex" style="width: 70px;"><b>性别组: </b></label>        
                    <select name="Sex" id="SexSingle" style="width: 240px;">
                        <option value="">选择性别组</option>
                    </select>
                </div>
    
                <div class="input-box mb-5">
                    <label for="AgeGroupID" style="width: 70px;"><b>年龄组: </b></label>        
                    <select name="AgeGroupID" id="AgeGroupIDSingle" style="width: 240px;">
                        <option value="">选择年龄组</option>
                    </select>
                </div>
            </div>
            <div class="sub">发送</div>
        
        </div>
        
    </form>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
<script src="public/layui/layui.js"></script>

<script>



    function CheckIsSingle(OneId, sexId, callback) {
        $.ajax({
            url: '/ctfcitemplayer/getTypeOfItem',
            type: 'Get',
            dataType: 'json',
            data: {
                ItemID: OneId,
            },
            header: {
                Accept: 'application/json'
            },
            success: function (data) {
                currentIsSingleFlag = data['affectedRows']
                // console.log('IsSingle=' + currentIsSingleFlag);
                
                var dropdowns = document.getElementsByClassName('dropdown');
                for (var j = 0; j < dropdowns.length; j++) {
                    dropdowns[j].style.display = 'none';
                }
                document.getElementById(currentIsSingleFlag + '-dropdown').style.display = 'block';
                
                callback(currentIsSingleFlag);
            }
        });
    }

    function getPlayerList(sitemID, siSex, siMinAG, siMaxAG, teamID, SsID, callback) {

        let currentPlayerList = [];
        $.ajax({
            url: '/ctfcitemplayer/getSeasonTeamPlayers',
            type: 'Get',
            dataType: 'json',
            data: {
            SiMinAG: siMinAG,
            SiMaxAG: siMaxAG,
            SiID: sitemID,
            SiSex: siSex,
            Tmid: teamID,
            SsID,SsID
            },
            header: {
            Accept: 'application/json'
            },
            success: function (data) {
            currentPlayerList = data['affectedRows'];
            // console.log('PlayerList=' + currentPlayerList);
            callback(currentPlayerList);
            },
            error: function (xhr) {
            console.log(xhr.status);
            }
        });
    }

    function updatePlayerList(currentItemid, currentSex, seasonitemFiltersMinAG,seasonitemFiltersMaxAG, SelectedTeamID, SelectedSeasonID) {
        // console.log("SelectedSeasonID: " + SelectedSeasonID);
        // console.log("currentItemid: " + currentItemid);
        // console.log("currentSex: " + currentSex);
        // console.log("SelectedTeamID: " + SelectedTeamID);
        // console.log("seasonitemFiltersMin Age: " + seasonitemFiltersMinAG);
        // console.log("seasonitemFiltersMax Age: " + seasonitemFiltersMaxAG);
                
        getPlayerList(currentItemid, currentSex, seasonitemFiltersMinAG,seasonitemFiltersMaxAG, SelectedTeamID, SelectedSeasonID, function(currentPlayerList) {
            // console.log('PlayerList=' + currentPlayerList);
            $('#PlayerID').empty();
            $('#PlayerID').append('<option value="">' + "选择队员" + '</option>');
            
            axios.get('/CTFCPlayer?all=1', {}).then(function (response) {
                $.each(response.data.data, function (index, item) {
                    if(currentPlayerList.includes(item.ID)) {
                        $('#PlayerID').append('<option value="' + item.ID + '">' + item.Name + '</option>');
                    }
                });
            }).catch(function (error) {
                console.log(error);
            });
        });
    }

    function getPlayerAgeSex(playerid, callback) {
        $.ajax({
            url: '/ctfcitemplayer/getAgeSex',
            type: 'Get',
            dataType: 'json',
            data: {
            PlayerID: playerid
            },
            header: {
            Accept: 'application/json'
            },
            success: function (data) {
            playerAgeAndSex = data['affectedRows'];
            callback(playerAgeAndSex[0], playerAgeAndSex[1]);
            },
            error: function (xhr) {
            console.log(xhr.status);
            }
        });

    }
    // getting select options for season. 
    axios.get('/CTFCSeason', {}).then(function (response) {
            console.log(response);
            const data = response.data.data;
        $.each(data, function (index, item) {
        $('#SeasonID').append('<option value="' + item.ID + '">' + item.Name + '</option>');
        });
    }).catch(function (error) {
            console.log(error);
    });


    // Event listener for the SeasonID select change
    $('#SeasonID').on('change', function () {
        var selectedSeasonID = $(this).val();
        if (!selectedSeasonID) {
            // Empty the TeamID select options
            $('#TeamID').empty();
            $('#TeamID').append('<option value="">' + "选择队伍" + '</option>');
            $('#ItemID').empty();
            $('#ItemID').append('<option value="">' + "选择项目" + '</option>');
            return;
        }

        // Get Seasonteam
        axios.get('/CTFCSeasonteam?seasonid=' + selectedSeasonID, {}).then(function (response) {
        // console.log(response);
            const data = response.data.data;

        $('#TeamID').empty();
        $('#TeamID').append('<option value="">' + "选择队伍" + '</option>');

        if (data.length !== 0) {
            $.each(data, function (index, item) {
                $('#TeamID').append('<option value="' + item.TeamID + '">' + item.TeamName + '</option>');
            });
            }
        }).catch(function (error) {
                console.log(error);
        });

        // Get Seasonitem
        axios.get('/CTFCSeasonitem?seasonid=' + selectedSeasonID, {}).then(function (response) {
        // console.log(response);
            const data = response.data.data;

        $('#ItemID').empty();
        $('#ItemID').append('<option value="">' + "选择项目" + '</option>');

        if (data.length !== 0) {
            $.each(data, function (index, item) {
                $('#ItemID').append('<option value="' + item.ItemID + '-' + item.Sex + '">' + item.Sex + " - " + item.ItemName +  '</option>');

            });
            }
        }).catch(function (error) {
                console.log(error);
        });

    });


    $('#ItemID').on('change', function () {
        var selectedItemSex = $(this).val().split("-");;
        var xiangmu = selectedItemSex[0];
        var xiangmuSex = selectedItemSex[1];
        var SelectedTeamID = document.getElementById('TeamID').value;
        var SelectedSeasonID = document.getElementById('SeasonID').value;
        CheckIsSingle(xiangmu, xiangmuSex, function(currentIsSingleFlag) {
            if(currentIsSingleFlag == 0) {
                // Multiple player item
                // Update AgeGroup option feild
                // Update playerlist

            } else {
                // console.log("CheckIsSingle:"+currentIsSingleFlag);

                // single player only update playerlist
                axios.get('/ctfcitemseasonitemagegroupview?seasonid=' + SelectedSeasonID, {}).then(function (response) {
                    const data = response.data.data;
                    $.each(response.data.data, function (index, item) {
                        if(item.ItemID == xiangmu && item.Sex == xiangmuSex) {
                            seasonitemFiltersMinAG = item.MinAgeGroupMinAge;
                            seasonitemFiltersMaxAG = item.MaxAgeGroupMaxAge;

                            updatePlayerList(xiangmu, xiangmuSex, seasonitemFiltersMinAG,seasonitemFiltersMaxAG, SelectedTeamID, SelectedSeasonID);
                        }
                    });
                }).catch(function (error) {
                    console.log(error);
                });
            }
        });
    });

    // Single player option button
    $('#PlayerID').on('change', function () {
        var playerid = document.getElementById('PlayerID').value;
            $('#AgeGroupIDSingle').empty();
            $('#SexSingle').empty();

            getPlayerAgeSex(playerid, function(playerAgeGroup, playerSex){
                axios.get('/CTFCAgegroup', {}).then(function (response) {
                    // console.log(response);
                    $.each(response.data.data, function (index, element) {
                        if(playerAgeGroup == element.ID) {
                            $('#AgeGroupIDSingle').append('<option value="' + element.ID + '">' + element.Name + ' ' + element.MinAge + '-' + element.MaxAge + '</option>');
                        }
                    });
                })
                //get Sex option from seasonitem option
                const parts = document.getElementById('ItemID').value.split("-");
                xiangmu = parts[0];
                xiangmuSex = parts[1];
                $('#SexSingle').append('<option value="' + xiangmuSex + '">' + xiangmuSex + '</option>');
        });
    });




</script>